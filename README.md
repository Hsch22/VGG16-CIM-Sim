# VGG16 存内计算 (CIM) 仿真框架

本项目实现了一个基于 PyTorch 的存内计算 (Computing-in-Memory, CIM) 仿真框架。通过将标准的 VGG16 卷积神经网络转换为模拟 CIM 硬件行为的模型，本项目能够评估存内计算架构在不同阵列尺寸、量化精度和模拟噪声条件下的性能（时延、能耗、精度）。

课程视频已上传至北大网盘：
链接：https://disk.pku.edu.cn/link/AAE42920C3229444E6883CB2AF2FB9DA9A
文件夹名称：实践课1
有效期至：2027年2月7日 13:11
请在有效期内下载观看。若直接在IDE中播放，可能会出现无声音的情况。

## 📁 代码文件说明

本项目包含 6 个核心步骤代码，建议按顺序阅读和运行：

### 1. 基础准备 (`step1_prepare.py`)
*   **功能**：环境初始化与基准测试。
*   **详情**：
    *   加载标准的 VGG16 预训练模型。
    *   定义图像预处理流程。
    *   运行一次标准推理，生成“标准答案”。
    *   保存输入张量和输出结果到 `baseline_data.pth`，作为后续步骤的对比基准。

### 2. CIM 核心实现 (`step2_cim_impl.py`)
*   **功能**：底层算子实现。
*   **详情**：
    *   `CIM_Tile`：模拟存储阵列的矩阵乘法行为。
    *   `CIM_Conv2d`：基于 `im2col` 技术，将卷积操作转化为适合 CIM 阵列的矩阵计算。
    *   验证脚本：证明 CIM 卷积实现与 PyTorch 标准卷积在数学上是等价的。

### 3. 全模型组装 (`step3_full_vgg.py`)
*   **功能**：模型转换与端到端验证。
*   **详情**：
    *   `VGG16_CIM`：自动遍历 VGG16 结构，将所有 `Conv2d` 和 `Linear` 层替换为 CIM 仿真层。
    *   加载 Step 1 生成的数据，验证转换后的整个网络推理结果是否正确。

### 4. 硬件全功能仿真 (`step4_full_chip_sim.py`)
*   **功能**：物理感知与性能统计。
*   **详情**：
    *   引入 `SimConfig` 配置类，管理架构参数（如阵列大小 128x128）。
    *   引入量化模拟（Quantization）。
    *   引入能耗/时延模型：计算 MAC 动态能耗、ADC 开销、数字逻辑开销以及跨阵列累加（Accumulation）开销。
    *   **核心权衡逻辑**：阵列越大，单次计算能耗越高；阵列越小，跨阵列累加开销越大。

### 5. 自动化实验 (`step5_experiment.py`)
*   **功能**：消融实验 (Ablation Study)。
*   **详情**：
    *   **量化分析**：测试从 Int2 到 Int32 不同位宽下的精度变化。
    *   **尺寸权衡**：扫描从 64x64 到 512x512 的阵列尺寸，分析时延与能耗的 Trade-off。
    *   **噪声测试**：注入高斯噪声，评估模拟电路的鲁棒性。
    *   自动绘制并保存结果图表 (`.svg`, `.pdf`)。

### 6. 批量测试 (`step6_batch_test.py`)
*   **功能**：实际应用演示。
*   **详情**：
    *   扫描 `experiment/` 文件夹下的所有图片。
    *   自动执行 CIM 仿真推理。
    *   输出每张图片的预测类别、硬件能耗 (uJ) 和时延数据。

---

## 🚫 关于 .gitignore 忽略文件说明

在版本控制中，以下文件通常被添加到 `.gitignore` 中以被忽略，原因如下：

### 1. `__pycache__/`
*   Python 解释器生成的字节码缓存文件夹，包含 `.pyc` 文件。
*   这些是编译后的机器相关文件，不是源代码。它们会根据不同的 Python 版本和操作系统重新生成。

### 2. `model/` 或 `*.pth`
*   PyTorch 的模型权重文件。
*   这些权重可以从官方源下载，或者是通过代码生成的。

### 3. `baseline_data.pth`
*   Step 1 生成的中间数据文件，包含用于校验的 Tensor 数据。
*   这是一个运行时生成的临时文件。任何用户运行 `step1_prepare.py` 都能重新生成它。

### 4. `*.svg` / `*.pdf` (如 `vgg16_cim_experiments.svg`)
*   Step 5 生成的实验结果图表。
*   这些是程序的“输出结果”而非“源代码”。每次修改代码逻辑后运行实验都会产生新的图表。

### 5. `experiment/` (部分情况)
*   存放测试图片的文件夹。

---

## 🚀 运行指南

1.  确保已安装 Python 及依赖库 (`torch`, `torchvision`, `Pillow`, `matplotlib`, `numpy`)。
2.  依次运行 Step 1 至 Step 6 即可体验完整流程。
3.  若需修改硬件参数，请编辑 `step4_full_chip_sim.py` 中的 `CONFIG` 类。

